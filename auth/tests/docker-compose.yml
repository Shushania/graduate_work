version: "3.5"

services:

  pg:
    image: postgres:14.0-alpine
    env_file: .env.sample
    container_name: auth_test_pg
    restart: on-failure

  redis:
    image: "redis:5-alpine"
    container_name: auth_test_redis
    expose:
      - "6379"
    restart: always

  auth:
    build:
      context: ../
      dockerfile: Dockerfile
    image: auth_image_test
    environment:
      - APP_NAME=AuthApp
      - FLASK_APP=app.py
    container_name: auth_test
    expose:
      - "5000"
    depends_on:
      - pg
      - redis

  tests:
    container_name: auth_tests_test
    image: auth_image_test
    env_file:
      - ./.env.sample
    entrypoint: >
      sh -c "pip install -r /app/tests/functional/requirements.txt
      && python3 /app/tests/functional/utils/wait_for_pg.py
      && pytest /app/tests/functional/src"
    depends_on:
      - auth
    restart: "no"
